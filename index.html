<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Realtime Quiz</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      set,
      push,
      onValue,
      update,
      get
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB3-b8Z5i6kgVX8ciRjF_4BrBwhU-AKlWY",
      authDomain: "fir-test-3fbfe.firebaseapp.com",
      databaseURL: "https://fir-test-3fbfe-default-rtdb.firebaseio.com",
      projectId: "fir-test-3fbfe",
      storageBucket: "fir-test-3fbfe.appspot.com",
      messagingSenderId: "1087880531981",
      appId: "1:1087880531981:web:0ed9e5053d8f3dc5242321",
      measurementId: "G-XD3G88VV5N"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const questions = [
      {
        question: "¿Cuál es la capital de Francia?",
        answers: ["París", "Londres", "Madrid", "Berlín"],
        correct: 0,
      },
      {
        question: "¿Quién pintó la Mona Lisa?",
        answers: [
          "Leonardo da Vinci",
          "Pablo Picasso",
          "Vincent Van Gogh",
          "Claude Monet",
        ],
        correct: 0,
      },
      {
        question: "¿Cuál es el río más largo del mundo?",
        answers: ["Nilo", "Amazonas", "Yangtsé", "Misisipi"],
        correct: 1,
      },
    ];

    let roomId = "sala1";
    let username = "";
    let userList = [];
    let hasStarted = false;

    const appDiv = document.getElementById("app");

    function joinRoom() {
      username = document.getElementById("username").value;
      if (!username) return;

      const usersRef = ref(db, `salas/${roomId}/users`);
      push(usersRef, username).then(() => {
        listenToUsers(roomId);
        showWaitingRoom();
      });
    }

    function listenToUsers(roomId) {
      const usersRef = ref(db, `salas/${roomId}/users`);
      onValue(usersRef, (snapshot) => {
        userList = Object.values(snapshot.val() || {});
        updateUserListUI(userList);

        if (userList.length >= 3 && !hasStarted) {
          hasStarted = true;
          startCountdown();
        }
      });
    }

    function updateUserListUI(users) {
      const usersDiv = document.getElementById("users");
      usersDiv.innerHTML = "<h3>Jugadores:</h3><ul>" + users.map(u => `<li>${u}</li>`).join("") + "</ul>";
    }

    function showWaitingRoom() {
      appDiv.innerHTML = `
        <h2>Esperando jugadores...</h2>
        <div id="users"></div>
      `;
    }

    function startCountdown() {
      const countdownDiv = document.createElement("div");
      countdownDiv.id = "countdown";
      appDiv.appendChild(countdownDiv);

      let seconds = 5;
      countdownDiv.innerText = `El juego empieza en ${seconds}...`;

      const interval = setInterval(() => {
        seconds--;
        countdownDiv.innerText = `El juego empieza en ${seconds}...`;
        if (seconds === 0) {
          clearInterval(interval);
          launchGame();
        }
      }, 1000);
    }

    function launchGame() {
      appDiv.innerHTML = `
        <h2>¡Comienza el juego!</h2>
        <div id="turn-indicator"></div>
        <div id="question-container"></div>
        <div id="ranking"></div>
      `;

      const stateRef = ref(db, `salas/${roomId}/state`);
      set(stateRef, {
        questionIndex: 0,
        turnIndex: 0,
        scores: {},
      });

      listenToState();
    }

    function listenToState() {
      const stateRef = ref(db, `salas/${roomId}/state`);
      onValue(stateRef, (snapshot) => {
        const state = snapshot.val();
        if (!state) return;

        const { questionIndex, turnIndex, scores } = state;
        if (questionIndex >= questions.length) {
          showFinalScores(scores);
          return;
        }

        const currentPlayer = userList[turnIndex % userList.length];
        document.getElementById("turn-indicator").innerText = `Turno de: ${currentPlayer}`;
        renderQuestion(questionIndex, currentPlayer);
        renderRanking(scores);
      });
    }

    function renderQuestion(index, currentPlayer) {
      const question = questions[index];
      if (!question) return;

      const container = document.getElementById("question-container");
      container.innerHTML = `
        <h3>${question.question}</h3>
        <div id="answers">
          ${question.answers.map((ans, i) => `<button data-index="${i}">${ans}</button>`).join("")}
        </div>
      `;

      document.querySelectorAll("#answers button").forEach(btn => {
        btn.onclick = () => {
          if (username !== currentPlayer) {
            alert("Esperá tu turno.");
            return;
          }

          const selectedIndex = parseInt(btn.dataset.index);
          const isCorrect = selectedIndex === question.correct;

          get(ref(db, `salas/${roomId}/state`)).then((snap) => {
            const state = snap.val();
            if (!state) return;

            const scores = state.scores || {};
            scores[username] = (scores[username] || 0) + (isCorrect ? 1 : 0);

            const nextTurn = state.turnIndex + 1;
            const nextQuestion = nextTurn % userList.length === 0
              ? state.questionIndex + 1
              : state.questionIndex;

            update(ref(db, `salas/${roomId}/state`), {
              turnIndex: nextTurn,
              questionIndex: nextQuestion,
              scores: scores
            });
          });
        };
      });
    }

    function renderRanking(scores) {
      const ranking = document.getElementById("ranking");
      const sorted = Object.entries(scores || {}).sort((a, b) => b[1] - a[1]);
      ranking.innerHTML = `
        <h3>Ranking</h3>
        <ul>
          ${sorted.map(([user, score]) => `<li>${user}: ${score}</li>`).join("")}
        </ul>
      `;
    }

    function showFinalScores(scores) {
      appDiv.innerHTML = `
        <h2>Juego terminado</h2>
        <div id="ranking"></div>
      `;
      renderRanking(scores);
    }

    // UI inicial
    appDiv.innerHTML = `
      <h1>Juego de Preguntas</h1>
      <input type="text" id="username" placeholder="Tu nombre" />
      <button onclick="joinRoom()">Unirse</button>
    `;

    window.joinRoom = joinRoom;

  </script>
</head>
<body>
  <div id="app"></div>
</body>
</html>
