<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quiz Multiplayer</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    #question { margin-top: 20px; }
    #answers button { display: block; margin: 8px 0; }
    #countdown { font-size: 24px; color: red; margin-top: 10px; }
    #ranking { margin-top: 20px; }
    #usersList { margin-top: 10px; }
  </style>
</head>
<body>

  <h1>Quiz Multiplayer</h1>
  <div>
    <label>Tu nombre: <input id="usernameInput" type="text" /></label>
    <button id="joinBtn">Unirse a la sala</button>
  </div>

  <div id="gameArea" style="display:none;">
    <h2>Jugadores en sala:</h2>
    <ul id="usersList"></ul>

    <div id="turnIndicator"></div>

    <div id="question"></div>
    <div id="answers"></div>
    <div id="countdown"></div>

    <div id="ranking"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // Config Firebase (poné la tuya)
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_AUTH_DOMAIN",
      databaseURL: "TU_DATABASE_URL",
      projectId: "TU_PROJECT_ID",
      storageBucket: "TU_STORAGE_BUCKET",
      messagingSenderId: "TU_MESSAGING_SENDER_ID",
      appId: "TU_APP_ID"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Variables globales
    let currentUserName = "";
    let currentRoomId = "sala1";
    let hasCountdownStarted = false;
    let countdownValue = 15;
    let countdownTimer;

    const questions = [
      { text: "¿Capital de Argentina?", options: ["Buenos Aires", "Lima", "Santiago"], correctIndex: 0 },
      { text: "¿Color del cielo?", options: ["Verde", "Azul", "Rojo"], correctIndex: 1 },
      { text: "¿2+2?", options: ["3", "4", "5"], correctIndex: 1 },
      // ... agregá más preguntas si querés
    ];

    // Elementos DOM
    const usernameInput = document.getElementById("usernameInput");
    const joinBtn = document.getElementById("joinBtn");
    const gameArea = document.getElementById("gameArea");
    const usersListUl = document.getElementById("usersList");
    const turnIndicatorDiv = document.getElementById("turnIndicator");
    const questionDiv = document.getElementById("question");
    const answersDiv = document.getElementById("answers");
    const countdownDiv = document.getElementById("countdown");
    const rankingDiv = document.getElementById("ranking");

    joinBtn.onclick = () => {
      const name = usernameInput.value.trim();
      if (!name) {
        alert("Ingresá un nombre válido");
        return;
      }
      currentUserName = name;
      joinRoom(currentRoomId, currentUserName);
    };

    // Función para unirse a la sala
    function joinRoom(roomId, userName) {
      // Guardar usuario en Firebase
      const userRef = ref(db, `salas/${roomId}/usuarios/${userName}`);
      set(userRef, true).then(() => {
        gameArea.style.display = "block";
        usernameInput.disabled = true;
        joinBtn.disabled = true;

        listenToUsers(roomId);
        listenToState(roomId);
      });
    }

    // Escuchar usuarios, guardar lista ordenada en Firebase
    function listenToUsers(roomId) {
      hasCountdownStarted = false;
      countdownValue = 15;
      countdownDiv.textContent = "";

      const usuariosRef = ref(db, `salas/${roomId}/usuarios`);
      onValue(usuariosRef, snapshot => {
        const usersObj = snapshot.val() || {};
        const userList = Object.keys(usersObj).sort();

        // Guardar lista ordenada para sincronización
        set(ref(db, `salas/${roomId}/ordenUsuarios`), userList);

        // Mostrar lista en UI
        usersListUl.innerHTML = "";
        userList.forEach(user => {
          const li = document.createElement("li");
          li.textContent = user;
          usersListUl.appendChild(li);
        });

        if (userList.length >= 3 && !hasCountdownStarted) {
          startCountdown();
        }
      });
    }

    // Escuchar estado (turno, pregunta, scores)
    function listenToState(roomId) {
      // Listener turno
      const turnRef = ref(db, `salas/${roomId}/state/turnIndex`);
      onValue(turnRef, async snapshot => {
        const turnIndex = snapshot.val();
        if (turnIndex === null || turnIndex === undefined) return;

        const ordenRef = ref(db, `salas/${roomId}/ordenUsuarios`);
        const ordenSnap = await new Promise(resolve => {
          onValue(ordenRef, snap => resolve(snap), { onlyOnce: true });
        });
        const userList = ordenSnap.val() || [];
        if (userList.length === 0) return;

        const questionIndexRef = ref(db, `salas/${roomId}/state/questionIndex`);
        const qSnap = await new Promise(resolve => {
          onValue(questionIndexRef, snap => resolve(snap), { onlyOnce: true });
        });
        const questionIndex = qSnap.val() || 0;
        if (questionIndex >= questions.length) {
          endQuizUI();
          return;
        }

        const currentPlayer = userList[turnIndex % userList.length];
        turnIndicatorDiv.textContent = `Turno de: ${currentPlayer}`;

        showQuestionUI(questionIndex, currentPlayer);
      });

      // Listener pregunta
      const qRef = ref(db, `salas/${roomId}/state/questionIndex`);
      onValue(qRef, async snapshot => {
        const questionIndex = snapshot.val();
        if (questionIndex === null || questionIndex === undefined) return;
        if (questionIndex >= questions.length) {
          endQuizUI();
          return;
        }

        const ordenRef = ref(db, `salas/${roomId}/ordenUsuarios`);
        const ordenSnap = await new Promise(resolve => {
          onValue(ordenRef, snap => resolve(snap), { onlyOnce: true });
        });
        const userList = ordenSnap.val() || [];
        if (userList.length === 0) return;

        const turnIndexRef = ref(db, `salas/${roomId}/state/turnIndex`);
        const tSnap = await new Promise(resolve => {
          onValue(turnIndexRef, snap => resolve(snap), { onlyOnce: true });
        });
        const turnIndex = tSnap.val() || 0;

        const currentPlayer = userList[turnIndex % userList.length];

        turnIndicatorDiv.textContent = `Turno de: ${currentPlayer}`;
        showQuestionUI(questionIndex, currentPlayer);
      });

      // Listener scores
      const scoresRef = ref(db, `salas/${roomId}/state/scores`);
      onValue(scoresRef, snapshot => {
        const scores = snapshot.val() || {};
        updateRankingUI(scores);
      });
    }

    // Mostrar pregunta y opciones solo al jugador cuyo turno es
    function showQuestionUI(questionIndex, currentPlayer) {
      if (currentUserName !== currentPlayer) {
        questionDiv.textContent = "Esperando turno...";
        answersDiv.innerHTML = "";
        countdownDiv.textContent = "";
        return;
      }
      const qObj = questions[questionIndex];
      if (!qObj) {
        questionDiv.textContent = "No hay más preguntas.";
        answersDiv.innerHTML = "";
        countdownDiv.textContent = "";
        return;
      }

      questionDiv.textContent = qObj.text;
      answersDiv.innerHTML = "";

      qObj.options.forEach((opt, i) => {
        const btn = document.createElement("button");
        btn.textContent = opt;
        btn.onclick = () => {
          clearInterval(countdownTimer);
          handleAnswer(i);
        };
        answersDiv.appendChild(btn);
      });
    }

    // Actualizar ranking en UI
    function updateRankingUI(scores) {
      rankingDiv.innerHTML = "<h3>Ranking:</h3>";
      const entries = Object.entries(scores);
      entries.sort((a, b) => b[1] - a[1]);
      if (entries.length === 0) {
        rankingDiv.innerHTML += "<p>No hay puntajes aún.</p>";
        return;
      }
      const ul = document.createElement("ul");
      entries.forEach(([user, score]) => {
        const li = document.createElement("li");
        li.textContent = `${user}: ${score}`;
        ul.appendChild(li);
      });
      rankingDiv.appendChild(ul);
    }

    // Contador para iniciar juego cuando haya 3 o más jugadores
    function startCountdown() {
      hasCountdownStarted = true;
      countdownValue = 15;
      countdownDiv.textContent = `El juego empieza en: ${countdownValue}s`;

      countdownTimer = setInterval(() => {
        countdownValue--;
        countdownDiv.textContent = `El juego empieza en: ${countdownValue}s`;
        if (countdownValue <= 0) {
          clearInterval(countdownTimer);
          initializeGame();
        }
      }, 1000);
    }

    // Iniciar el juego: poner turno y pregunta en 0 y scores vacíos
    function initializeGame() {
      set(ref(db, `salas/${currentRoomId}/state`), {
        turnIndex: 0,
        questionIndex: 0,
        scores: {}
      });
    }

    // Finalizar juego UI
    function endQuizUI() {
      questionDiv.textContent = "El quiz terminó.";
      answersDiv.innerHTML = "";
      countdownDiv.textContent = "";
      turnIndicatorDiv.textContent = "";
    }

    // Manejar respuesta (solo si es tu turno)
    async function handleAnswer(selectedIndex) {
      try {
        const ordenRef = ref(db, `salas/${currentRoomId}/ordenUsuarios`);
        const ordenSnap = await new Promise(resolve => {
          onValue(ordenRef, snap => resolve(snap), { onlyOnce: true });
        });
        const userList = ordenSnap.val() || [];
        if (userList.length === 0) return;

        const stateRef = ref(db, `salas/${currentRoomId}/state`);
        runTransaction(stateRef, state => {
          if (!state) return state;
          const qIndex = state.questionIndex || 0;
          const scores = state.scores || {};
          const turnIndex = state.turnIndex || 0;

          const currentPlayer = userList[turnIndex % userList.length];
          if (currentPlayer !== currentUserName) return state;

          const qObj = questions[qIndex];
          if (!qObj) return state;

          if (selectedIndex === qObj.correctIndex) {
            state.scores[currentUserName] = (state.scores[currentUserName] || 0) + 1;
          }

          const nextTurn = (turnIndex + 1) % userList.length;
          if (nextTurn === 0) {
            state.questionIndex = qIndex + 1;
          }
          state.turnIndex = nextTurn;
          return state;
        }, {
          onComplete: (err, committed, snapshot) => {
            if (err) console.error("runTransaction error:", err);
            if (!committed) console.warn("Transaction no fue comprometida");
          }
        });
      } catch (e) {
        console.error("Error en handleAnswer:", e);
      }
    }

  </script>
</body>
</html>
