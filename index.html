<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Realtime Quiz</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      set,
      push,
      onValue,
      update,
      get
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB3-b8Z5i6kgVX8ciRjF_4BrBwhU-AKlWY",
      authDomain: "fir-test-3fbfe.firebaseapp.com",
      databaseURL: "https://fir-test-3fbfe-default-rtdb.firebaseio.com",
      projectId: "fir-test-3fbfe",
      storageBucket: "fir-test-3fbfe.appspot.com",
      messagingSenderId: "1087880531981",
      appId: "1:1087880531981:web:0ed9e5053d8f3dc5242321",
      measurementId: "G-XD3G88VV5N"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const questions = [
      {
        question: "¿Cuál es la capital de Francia?",
        answers: ["París", "Londres", "Madrid", "Berlín"],
        correct: 0,
      },
      {
        question: "¿Quién pintó la Mona Lisa?",
        answers: ["Leonardo da Vinci", "Pablo Picasso", "Van Gogh", "Monet"],
        correct: 0,
      },
      {
        question: "¿Cuál es el río más largo del mundo?",
        answers: ["Nilo", "Amazonas", "Yangtsé", "Misisipi"],
        correct: 1,
      },
    ];

    let roomId = "sala1";
    let username = "";
    let userList = [];
    let hasStarted = false;

    const div1 = document.getElementById("div1");
    const div2 = document.getElementById("div2");
    const div3 = document.getElementById("div3");

    function joinRoom() {
      username = document.getElementById("username").value;
      if (!username) return;

      const usersRef = ref(db, `salas/${roomId}/users`);
      push(usersRef, username).then(() => {
        listenToUsers(roomId);
        div1.style.display = "none";
        div2.style.display = "block";
      });
    }

    function listenToUsers(roomId) {
      const usersRef = ref(db, `salas/${roomId}/users`);
      onValue(usersRef, (snapshot) => {
        userList = Object.values(snapshot.val() || {});
        document.getElementById("users").innerHTML = userList.join("<br>");

        if (userList.length >= 3 && !hasStarted) {
          hasStarted = true;
          startCountdown();
        }
      });
    }

    function startCountdown() {
      let seconds = 5;
      const countdown = document.getElementById("countdown");
      countdown.innerText = `Comenzando en ${seconds}...`;
      const interval = setInterval(() => {
        seconds--;
        countdown.innerText = `Comenzando en ${seconds}...`;
        if (seconds === 0) {
          clearInterval(interval);
          launchGame();
        }
      }, 1000);
    }

    function launchGame() {
      div2.style.display = "none";
      div3.style.display = "block";

      const stateRef = ref(db, `salas/${roomId}/state`);
      set(stateRef, {
        questionIndex: 0,
        turnIndex: 0,
        scores: {},
      });

      listenToState();
    }

    function listenToState() {
      const stateRef = ref(db, `salas/${roomId}/state`);
      onValue(stateRef, (snapshot) => {
        const state = snapshot.val();
        if (!state) return;

        const { questionIndex, turnIndex, scores } = state;
        if (questionIndex >= questions.length) {
          showFinalScores(scores);
          return;
        }

        const currentPlayer = userList[turnIndex % userList.length];
        document.getElementById("turn").innerText = `Turno de: ${currentPlayer}`;
        renderQuestion(questionIndex, currentPlayer);
        renderRanking(scores);
      });
    }

    function renderQuestion(index, currentPlayer) {
      const q = questions[index];
      const qDiv = document.getElementById("question");
      qDiv.innerHTML = `<h3>${q.question}</h3>`;
      const aDiv = document.getElementById("answers");
      aDiv.innerHTML = "";

      q.answers.forEach((ans, i) => {
        const btn = document.createElement("button");
        btn.innerText = ans;
        btn.onclick = () => {
          if (username !== currentPlayer) {
            alert("Esperá tu turno");
            return;
          }

          const correct = i === q.correct;
          get(ref(db, `salas/${roomId}/state`)).then((snap) => {
            const state = snap.val();
            const scores = state.scores || {};
            scores[username] = (scores[username] || 0) + (correct ? 1 : 0);

            const nextTurn = state.turnIndex + 1;
            const nextQuestion = nextTurn % userList.length === 0
              ? state.questionIndex + 1
              : state.questionIndex;

            update(ref(db, `salas/${roomId}/state`), {
              turnIndex: nextTurn,
              questionIndex: nextQuestion,
              scores: scores,
            });
          });
        };
        aDiv.appendChild(btn);
      });
    }

    function renderRanking(scores) {
      const rDiv = document.getElementById("ranking");
      const sorted = Object.entries(scores || {}).sort((a, b) => b[1] - a[1]);
      rDiv.innerHTML = "<h3>Ranking</h3>" + sorted.map(([u, s]) => `<div>${u}: ${s}</div>`).join("");
    }

    function showFinalScores(scores) {
      div3.innerHTML = `<h2>Juego terminado</h2>`;
      renderRanking(scores);
    }

    window.joinRoom = joinRoom;
  </script>
</head>
<body>
  <div id="div1">
    <h1>Unirse al Juego</h1>
    <input id="username" placeholder="Tu nombre" />
    <button onclick="joinRoom()">Unirse</button>
  </div>

  <div id="div2" style="display:none;">
    <h2>Esperando jugadores...</h2>
    <div id="users"></div>
    <div id="countdown"></div>
  </div>

  <div id="div3" style="display:none;">
    <div id="turn"></div>
    <div id="question"></div>
    <div id="answers"></div>
    <div id="ranking"></div>
  </div>
</body>
</html>
