<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bugura Quiz</title>
  <style>
    /* ————————————————————————————————————————————————————
       Estilos básicos para modo oscuro y diseño responsive
       ———————————————————————————————————————————————————— */
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: #FFFFFF;
    }
    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
    }
    h1, h2, h3, h4 {
      color: #FFFFFF;
      margin-bottom: 12px;
    }
    /* Título principal en rojo 3D y centrado */
    .title {
      color: #FF0000;
      text-align: center;
      font-size: 2em;
      margin-bottom: 24px;
      /* Efecto 3D con sombras */
      text-shadow: 
        2px 2px 0px #000000, 
        4px 4px 0px #000000, 
        6px 6px 0px #000000;
    }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      background-color: #1E1E1E;
      border: 1px solid #333333;
      border-radius: 4px;
      color: #FFFFFF;
      box-sizing: border-box;
    }
    button {
      background-color: #BB86FC;
      border: none;
      color: #000000;
      padding: 10px 16px;
      margin: 4px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:disabled {
      background-color: #555555;
      color: #AAAAAA;
      cursor: default;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }
    .message {
      margin-top: 8px;
      color: #CF6679;
    }
    .list-item {
      margin-left: 16px;
      margin-bottom: 4px;
    }
    .hidden {
      display: none;
    }
    .center {
      text-align: center;
      margin-top: 24px;
    }
    .question-text {
      font-size: 18px;
      margin: 16px 0;
    }
    .score-list {
      margin-top: 16px;
    }
    .score-item {
      margin-bottom: 4px;
    }
    @media (max-width: 480px) {
      .container {
        padding: 8px;
      }
      button {
        flex: 1 1 48%;
      }
      .title {
        font-size: 1.5em;
        text-shadow: 
          1px 1px 0px #000000, 
          2px 2px 0px #000000, 
          3px 3px 0px #000000;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ——————— Pantalla “Join Room” ——————— -->
    <div id="join-screen">
      <h1 class="title">Bugura Quiz</h1>
      <input type="text" id="input-room-id" placeholder="ID de la sala" />
      <input type="text" id="input-username" placeholder="Nombre de usuario" />

      <div class="row">
        <button id="btn-create-room">Crear Sala</button>
        <button id="btn-join-room">Unirse a Sala</button>
        <button id="btn-reset-all">Reiniciar Salas</button>
      </div>

      <div id="message" class="message"></div>

      <h3>Usuarios en sala:</h3>
      <ul id="users-list"></ul>

      <div id="countdown"></div>

      <!-- ——————— Ranking general ——————— -->
      <h3>Ranking General</h3>
      <ul id="ranking-list"></ul>
    </div>

    <!-- ——————— Pantalla “Quiz” ——————— -->
    <div id="quiz-screen" class="hidden">
      <h2>Quiz en Curso</h2>
      <div id="quiz-question" class="question-text"></div>
      <div id="quiz-options" class="row"></div>
      <div id="quiz-scores" class="score-list"></div>
      <div id="winner"></div>
    </div>
  </div>

  <!-- ————————————————————————————————————————————————————
       Firebase JS SDK (modular v9) + lógica JS
       Este bloque se coloca justo antes de </body>
       ———————————————————————————————————————————————————— -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      set,
      onValue,
      runTransaction,
      remove
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // ———————— 1. Configuración de Firebase ————————
    const firebaseConfig = {
      apiKey: "AIzaSyDAYh1x8p1wbdNEM4nA33y9sWh2Q3MrLxo",
      authDomain: "bugura-cf2cd.firebaseapp.com",
      databaseURL: "https://bugura-cf2cd-default-rtdb.firebaseio.com",
      projectId: "bugura-cf2cd",
      storageBucket: "bugura-cf2cd.firebasestorage.app",
      messagingSenderId: "170908399149",
      appId: "1:170908399149:web:5e9ab4cf06e8079fe16aa4"
    };

    console.log("Inicializando Firebase...");
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // ———————— 2. Variables globales ————————
    let currentRoomId     = "";
    let currentUserName   = "";
    let countdownInterval = null;

    // Referencias DOM
    const joinScreenDiv    = document.getElementById("join-screen");
    const quizScreenDiv    = document.getElementById("quiz-screen");

    const roomIdInput      = document.getElementById("input-room-id");
    const userNameInput    = document.getElementById("input-username");
    const btnCreateRoom    = document.getElementById("btn-create-room");
    const btnJoinRoom      = document.getElementById("btn-join-room");
    const btnResetAll      = document.getElementById("btn-reset-all");
    const messageDiv       = document.getElementById("message");

    const usersListUl      = document.getElementById("users-list");
    const countdownDiv     = document.getElementById("countdown");

    const quizQuestionText = document.getElementById("quiz-question");
    const quizOptionsDiv   = document.getElementById("quiz-options");
    const quizScoresDiv    = document.getElementById("quiz-scores");
    const winnerDiv        = document.getElementById("winner");

    const rankingListUl    = document.getElementById("ranking-list");

    // Banco de preguntas
    const questions = [
      {
        text: "¿Capital de Francia?",
        options: ["Londres", "Madrid", "París", "Berlín"],
        correctIndex: 2
      },
      {
        text: "¿5 + 7 = ?",
        options: ["10", "12", "11", "14"],
        correctIndex: 1
      },
      {
        text: "¿Color del cielo?",
        options: ["Verde", "Azul", "Rojo", "Amarillo"],
        correctIndex: 1
      }
    ];

    // ———————— 3. Funciones de “Join Room” ————————

    function showMessage(txt) {
      console.log("Mensaje:", txt);
      messageDiv.textContent = txt;
      setTimeout(() => {
        messageDiv.textContent = "";
      }, 3000);
    }

    function clearUsersList() {
      usersListUl.innerHTML = "";
    }

    function clearRankingList() {
      rankingListUl.innerHTML = "";
    }

    function createRoom() {
      const roomId   = roomIdInput.value.trim();
      const userName = userNameInput.value.trim();
      console.log("createRoom()", roomId, userName);
      if (!roomId || !userName) {
        showMessage("Completa ambos campos");
        return;
      }
      currentRoomId   = roomId;
      currentUserName = userName;

      // 1) Inicializa state (scores/turnIndex/questionIndex)
      set(ref(db, `salas/${roomId}/state`), {
        scores: { [userName]: 0 },
        turnIndex: 0,
        questionIndex: 0
      })
        .then(() => {
          // 2) Añade al host a “usuarios”
          joinRoom(roomId, userName);
          showMessage(`Sala "${roomId}" creada. Esperando jugadores...`);
        })
        .catch((err) => {
          console.error("Error createRoom:", err);
          showMessage("Error creando sala");
        });

      // 3) Limpieza automática tras 15 min
      clearTimeout(countdownInterval);
      setTimeout(() => {
        console.log("Limpiando sala automáticamente:", roomId);
        remove(ref(db, `salas/${roomId}`)).catch((e) => console.error(e));
      }, 15 * 60 * 1000);
    }

    function joinRoom(roomId, userName) {
      console.log("joinRoom()", roomId, userName);
      currentRoomId   = roomId;
      currentUserName = userName;

      // 1) Añade usuario a “usuarios”
      set(ref(db, `salas/${roomId}/usuarios/${userName}`), true)
        .then(() => {
          // 2) Asegura entrada en state/scores
          set(ref(db, `salas/${roomId}/state/scores/${userName}`), 0).catch((e) =>
            console.error("Error init score:", e)
          );
          showMessage(`Unido a sala "${roomId}". Esperando más jugadores...`);
          listenUsers(roomId);
        })
        .catch((err) => {
          console.error("Error joinRoom:", err);
          showMessage("Error al unirte");
        });
    }

    function resetAllRooms() {
      console.log("resetAllRooms()");
      remove(ref(db, "salas"))
        .then(() => {
          showMessage("Todas las salas reiniciadas");
          clearUsersList();
          countdownDiv.textContent = "";
        })
        .catch((err) => {
          console.error("Error resetAllRooms:", err);
          showMessage("Error reiniciando salas");
        });
    }

    function listenUsers(roomId) {
      console.log("listenUsers()", roomId);
      const usersRef = ref(db, `salas/${roomId}/usuarios`);
      onValue(
        usersRef,
        (snapshot) => {
          const data = snapshot.val() || {};
          const list = Object.keys(data);
          console.log("Usuarios actualmente:", list);

          clearUsersList();
          list.forEach((u) => {
            const li = document.createElement("li");
            li.textContent = u;
            li.classList.add("list-item");
            usersListUl.appendChild(li);
          });

          if (list.length >= 2 && !countdownInterval) {
            startCountdown();
          }
        },
        (error) => {
          console.error("listenUsers error:", error);
        }
      );
    }

    function startCountdown() {
      console.log("startCountdown()");
      let c = 15;
      countdownDiv.textContent = `Comienza en ${c}s`;
      countdownInterval = setInterval(() => {
        c--;
        if (c > 0) {
          countdownDiv.textContent = `Comienza en ${c}s`;
        } else {
          clearInterval(countdownInterval);
          countdownInterval = null;
          countdownDiv.textContent = "";
          console.log("Cuenta atrás finalizada; mostrando quiz");
          showQuizScreen();
        }
      }, 1000);
    }

    // ———————— 4. Funciones de “Quiz” ————————

    function showQuizScreen() {
      console.log("showQuizScreen()");
      joinScreenDiv.classList.add("hidden");
      quizScreenDiv.classList.remove("hidden");
      listenGameState(currentRoomId);
    }

    function listenGameState(roomId) {
      console.log("listenGameState()", roomId);
      const stateRef = ref(db, `salas/${roomId}/state`);
      onValue(
        stateRef,
        (snapshot) => {
          const val = snapshot.val();
          if (!val) {
            console.warn("listenGameState: state aún no existe");
            return;
          }

          const scores = val.scores || {};
          const turnIdx = val.turnIndex ?? 0;
          const qIdx    = val.questionIndex ?? 0;
          console.log("GameState change:", { scores, turnIdx, qIdx });

          // Comprueba si hay ganador (>=10)
          for (const [name, pts] of Object.entries(scores)) {
            if (pts >= 10) {
              // Incrementar ranking antes de mostrar ganador
              incrementRanking(name);
              showWinner(name);
              return;
            }
          }

          // Actualiza pregunta
          const pregunta = questions[qIdx];
          quizQuestionText.textContent = pregunta.text;

          const players        = Object.keys(scores);
          const currentTurn    = players[turnIdx] || "";
          const isMyTurn       = currentTurn === currentUserName;
          console.log("Turno:", currentTurn, "(soy yo:", isMyTurn, ")");

          // Genera botones de opciones
          quizOptionsDiv.innerHTML = "";
          pregunta.options.forEach((opt, i) => {
            const btn = document.createElement("button");
            btn.textContent = opt;
            btn.disabled   = !isMyTurn;
            btn.onclick    = () => submitAnswer(i);
            quizOptionsDiv.appendChild(btn);
          });

          // Muestra puntajes
          quizScoresDiv.innerHTML = "";
          Object.entries(scores).forEach(([name, pts]) => {
            const p = document.createElement("p");
            p.textContent = `${name}: ${pts} pts`;
            p.classList.add("score-item");
            quizScoresDiv.appendChild(p);
          });
        },
        (error) => {
          console.error("listenGameState error:", error);
        }
      );
    }

    function submitAnswer(selectedIdx) {
      console.log("submitAnswer(index):", selectedIdx);
      const stateRef = ref(db, `salas/${currentRoomId}/state`);
      runTransaction(
        stateRef,
        (currentData) => {
          if (currentData === null) return null;
          const scores = currentData.scores || {};
          const players = Object.keys(scores);
          const turnIdx = currentData.turnIndex ?? 0;
          const qIdx    = currentData.questionIndex ?? 0;

          const pregunta = questions[qIdx];
          if (
            players[turnIdx] === currentUserName &&
            selectedIdx === pregunta.correctIndex
          ) {
            scores[currentUserName] = (scores[currentUserName] || 0) + 1;
            console.log("Acertó:", currentUserName);
          } else {
            console.log("Falló o no era su turno");
          }

          currentData.turnIndex = (turnIdx + 1) % players.length;

          if (
            players[turnIdx] === currentUserName &&
            selectedIdx === pregunta.correctIndex
          ) {
            currentData.questionIndex = (qIdx + 1) % questions.length;
          }

          currentData.scores = scores;
          return currentData;
        },
        (error, committed, snapshot) => {
          if (error) console.error("Transaction error:", error);
          else if (!committed) console.warn("Transacción no se aplicó.");
        }
      );
    }

    function showWinner(name) {
      console.log("showWinner:", name);
      quizScreenDiv.innerHTML = `
        <div class="center">
          <h2>¡El ganador es ${name}!</h2>
          <p>Volviendo al inicio en 5 segundos…</p>
        </div>
      `;
      setTimeout(() => {
        window.location.reload();
      }, 5000);
    }

    // ———————— 5. Funciones de Ranking ————————

    /**
     * Incrementa en 1 el contador de victorias en /ranking/{username}.
     */
    function incrementRanking(winnerName) {
      console.log("incrementRanking()", winnerName);
      const rankRef = ref(db, `ranking/${winnerName}`);
      runTransaction(
        rankRef,
        (currentVal) => {
          if (currentVal === null) {
            return 1;
          }
          return currentVal + 1;
        },
        (error, committed, snapshot) => {
          if (error) console.error("incrementRanking error:", error);
        }
      );
    }

    /**
     * Escucha /ranking y actualiza la lista ordenada de mayor a menor.
     */
    function listenGlobalRanking() {
      const rankingRef = ref(db, "ranking");
      onValue(
        rankingRef,
        (snapshot) => {
          const data = snapshot.val() || {};
          // data = { usuario1: 3, usuario2: 5, ... }
          const arr = Object.entries(data); // [ ["usuario1",3], ["usuario2",5], ... ]
          // Ordena de mayor a menor según la segunda posición (wins)
          arr.sort((a, b) => b[1] - a[1]);
          console.log("Ranking actual:", arr);

          // Construye el <ul> con items "Usuario: victorias"
          clearRankingList();
          arr.forEach(([user, wins]) => {
            const li = document.createElement("li");
            li.textContent = `${user}: ${wins} victorias`;
            li.classList.add("list-item");
            rankingListUl.appendChild(li);
          });
        },
        (error) => {
          console.error("listenGlobalRanking error:", error);
        }
      );
    }

    // ———————— 6. Configurar eventos y arrancar listeners ————————

    btnCreateRoom.addEventListener("click", createRoom);
    btnJoinRoom.addEventListener("click", () => {
      const roomId   = roomIdInput.value.trim();
      const userName = userNameInput.value.trim();
      console.log("Botón Unirse clickeado:", roomId, userName);
      if (!roomId || !userName) {
        showMessage("Completa ambos campos");
        return;
      }
      joinRoom(roomId, userName);
    });
    btnResetAll.addEventListener("click", resetAllRooms);

    // Cuando cargue la página:
    window.addEventListener("load", () => {
      console.log("Página cargada, mostrando Join Room");
      joinScreenDiv.classList.remove("hidden");
      quizScreenDiv.classList.add("hidden");
      // Empezamos a escuchar el ranking global desde el inicio
      listenGlobalRanking();
    });
  </script>
</body>
</html>
