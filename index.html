<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quiz en Tiempo Real</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      set,
      push,
      onValue,
      update,
      get
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB3-b8Z5i6kgVX8ciRjF_4BrBwhU-AKlWY",
      authDomain: "fir-test-3fbfe.firebaseapp.com",
      databaseURL: "https://fir-test-3fbfe-default-rtdb.firebaseio.com",
      projectId: "fir-test-3fbfe",
      storageBucket: "fir-test-3fbfe.appspot.com",
      messagingSenderId: "1087880531981",
      appId: "1:1087880531981:web:0ed9e5053d8f3dc5242321",
      measurementId: "G-XD3G88VV5N"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const questions = [
      {
        question: "¿Cuál es la capital de Francia?",
        answers: ["París", "Londres", "Madrid", "Berlín"],
        correct: 0,
      },
      {
        question: "¿Quién pintó la Mona Lisa?",
        answers: [
          "Leonardo da Vinci",
          "Pablo Picasso",
          "Vincent Van Gogh",
          "Claude Monet",
        ],
        correct: 0,
      },
      {
        question: "¿Cuál es el río más largo del mundo?",
        answers: ["Nilo", "Amazonas", "Yangtsé", "Misisipi"],
        correct: 1,
      },
    ];

    let roomId = "sala1";
    let username = "";
    let userListGlobal = [];
    let hasCountdownStarted = false;

    const appDiv = document.getElementById("app");

    function joinRoom() {
      username = document.getElementById("username").value;
      if (!username) return alert("Ingrese un nombre de usuario");

      const userRef = ref(db, `salas/${roomId}/users`);
      push(userRef, username).then(() => {
        listenToUsers(roomId);
        showWaitingRoom();
      });
    }

    function listenToUsers(roomId) {
      const usersRef = ref(db, `salas/${roomId}/users`);
      onValue(usersRef, (snapshot) => {
        const userList = Object.values(snapshot.val() || {});
        userListGlobal = userList;

        const usersDiv = document.getElementById("users");
        usersDiv.innerHTML = "<h3>Jugadores en la sala:</h3><ul>" +
          userList.map(user => `<li>${user}</li>`).join("") + "</ul>";

        if (userList.length >= 3 && !hasCountdownStarted) {
          hasCountdownStarted = true;
          startCountdown();
        }
      });
    }

    function startCountdown() {
      const countdownDiv = document.createElement("div");
      countdownDiv.id = "countdown";
      appDiv.appendChild(countdownDiv);

      let counter = 5;
      countdownDiv.innerText = `El juego empieza en ${counter}...`;

      const interval = setInterval(() => {
        counter--;
        if (counter > 0) {
          countdownDiv.innerText = `El juego empieza en ${counter}...`;
        } else {
          clearInterval(interval);
          transitionToQuiz();
        }
      }, 1000);
    }

    function showWaitingRoom() {
      appDiv.innerHTML = `
        <h2>Esperando jugadores...</h2>
        <div id="users"></div>
      `;
    }

    function transitionToQuiz() {
      const stateRef = ref(db, `salas/${roomId}/state`);
      set(stateRef, {
        questionIndex: 0,
        turnIndex: 0,
        scores: {},
      });
      listenToState(roomId);
    }

    function listenToState(roomId) {
      const stateRef = ref(db, `salas/${roomId}/state`);
      onValue(stateRef, snapshot => {
        const state = snapshot.val();
        if (!state) return;

        const turnIndex = state.turnIndex ?? 0;
        const questionIndex = state.questionIndex ?? 0;

        if (questionIndex >= questions.length) {
          endQuizUI();
          return;
        }

        const currentPlayer = userListGlobal[turnIndex % userListGlobal.length];
        document.getElementById("turn-indicator").innerText = `Turno de: ${currentPlayer}`;
        showQuestionUI(questionIndex, currentPlayer);
        updateRankingUI(state.scores || {});
      });
    }

    function showQuestionUI(questionIndex, currentPlayer) {
      const questionData = questions[questionIndex];
      if (!questionData) return;

      let html = `
        <h2>${questionData.question}</h2>
        <div id="answers">
          ${questionData.answers.map((ans, idx) => `<button data-idx="${idx}">${ans}</button>`).join("")}
        </div>
      `;

      document.getElementById("question-container").innerHTML = html;

      document.querySelectorAll("#answers button").forEach(btn => {
        btn.onclick = () => {
          if (username !== currentPlayer) {
            alert("No es tu turno.");
            return;
          }

          const answerIndex = parseInt(btn.dataset.idx);
          const isCorrect = answerIndex === questionData.correct;

          get(ref(db, `salas/${roomId}/state`)).then(snapshot => {
            const state = snapshot.val();
            if (!state) return;

            const newScores = state.scores || {};
            const currentScore = newScores[username] || 0;
            newScores[username] = isCorrect ? currentScore + 1 : currentScore;

            const nextTurn = state.turnIndex + 1;
            const nextQuestion = nextTurn % userListGlobal.length === 0
              ? state.questionIndex + 1
              : state.questionIndex;

            update(ref(db, `salas/${roomId}/state`), {
              scores: newScores,
              turnIndex: nextTurn,
              questionIndex: nextQuestion,
            });
          });
        };
      });
    }

    function updateRankingUI(scores) {
      const rankingDiv = document.getElementById("ranking");
      const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);
      rankingDiv.innerHTML = `
        <h3>Ranking</h3>
        <ul>
          ${sorted.map(([user, score]) => `<li>${user}: ${score}</li>`).join("")}
        </ul>
      `;
    }

    function endQuizUI() {
      appDiv.innerHTML = "<h2>¡Juego terminado!</h2><div id='ranking'></div>";
      get(ref(db, `salas/${roomId}/state/scores`)).then(snapshot => {
        const scores = snapshot.val() || {};
        updateRankingUI(scores);
      });
    }

    // Pantalla inicial
    appDiv.innerHTML = `
      <h1>Juego de Preguntas</h1>
      <input type="text" id="username" placeholder="Tu nombre"/>
      <button onclick="joinRoom()">Unirse</button>
      <div id="turn-indicator"></div>
      <div id="question-container"></div>
      <div id="ranking"></div>
    `;

    window.joinRoom = joinRoom;

  </script>
</head>
<body>
  <div id="app"></div>
</body>
</html>
