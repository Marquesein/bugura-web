<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bugura Quiz (Web – Turnos con preguntas no repetidas)</title>
  <style>
    /* ————————————————————————————————————————————————————
       Estilos para modo oscuro y responsive
       ———————————————————————————————————————————————————— */
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: #FFFFFF;
    }
    .container {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
    }
    h1, h2, h3, h4 {
      color: #FFFFFF;
      margin-bottom: 12px;
    }
    .title {
      color: #FF0000;
      text-align: center;
      font-size: 2em;
      margin-bottom: 24px;
      text-shadow:
        2px 2px 0px #000000,
        4px 4px 0px #000000,
        6px 6px 0px #000000;
    }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 12px;
      background-color: #1E1E1E;
      border: 1px solid #333333;
      border-radius: 4px;
      color: #FFFFFF;
      box-sizing: border-box;
    }
    button {
      background-color: #BB86FC;
      border: none;
      color: #000000;
      padding: 10px 16px;
      margin: 4px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:disabled {
      background-color: #555555;
      color: #AAAAAA;
      cursor: default;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }
    .message {
      margin-top: 8px;
      color: #CF6679;
    }
    .list-item {
      margin-left: 16px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .hidden {
      display: none;
    }
    .center {
      text-align: center;
      margin-top: 24px;
    }
    .question-text {
      font-size: 18px;
      margin: 16px 0;
    }
    .score-list {
      margin-top: 16px;
    }
    .score-item {
      margin-bottom: 4px;
    }
    @media (max-width: 480px) {
      .container {
        padding: 8px;
      }
      button {
        flex: 1 1 48%;
      }
      .title {
        font-size: 1.5em;
        text-shadow:
          1px 1px 0px #000000,
          2px 2px 0px #000000,
          3px 3px 0px #000000;
      }
    }
    .crown-icon {
      width: 20px;
      height: 20px;
      fill: gold;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ——— Pantalla “Join Room” ——— -->
    <div id="join-screen">
      <h1 class="title">Bugura Quiz</h1>
      <input type="text" id="input-room-id" placeholder="ID de la sala" />
      <input type="text" id="input-username" placeholder="Nombre de usuario" />

      <div class="row">
        <button id="btn-create-room">Crear Sala</button>
        <button id="btn-join-room">Unirse a Sala</button>
        <button id="btn-reset-all">Reiniciar Salas</button>
      </div>

      <div id="message" class="message"></div>

      <h3>Usuarios en sala:</h3>
      <ul id="users-list"></ul>

      <div id="countdown" class="center"></div>

      <!-- —— Ranking de victorias —— -->
      <h3>👑 Ranking de victorias</h3>
      <ul id="ranking-list"></ul>
    </div>

    <!-- ——— Pantalla “Quiz” ——— -->
    <div id="quiz-screen" class="hidden">
      <h2 class="center">Quiz en Curso</h2>
      <div id="quiz-question" class="question-text"></div>
      <div id="turn-indicator" class="center"></div>
      <div id="quiz-options" class="row"></div>
      <div id="quiz-scores" class="score-list"></div>
      <div id="winner" class="center"></div>
    </div>
  </div>

  <!-- Firebase SDK v9 + lógica JS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      set,
      onValue,
      runTransaction,
      update,
      remove,
      get
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    // 1) Configuración de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDAYh1x8p1wbdNEM4nA33y9sWh2Q3MrLxo",
      authDomain: "bugura-cf2cd.firebaseapp.com",
      databaseURL: "https://bugura-cf2cd-default-rtdb.firebaseio.com",
      projectId: "bugura-cf2cd",
      storageBucket: "bugura-cf2cd.firebasestorage.app",
      messagingSenderId: "170908399149",
      appId: "1:170908399149:web:5e9ab4cf06e8079fe16aa4"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // 2) Variables globales
    let currentRoomId       = "";
    let currentUserName     = "";
    let countdownTimer      = null;
    let hasCountdownStarted = false;
    let countdownValue      = 15;
    let userListGlobal      = []; // Lista ordenada de usuarios

    // Referencias DOM
    const joinScreenDiv    = document.getElementById("join-screen");
    const quizScreenDiv    = document.getElementById("quiz-screen");
    const roomIdInput      = document.getElementById("input-room-id");
    const userNameInput    = document.getElementById("input-username");
    const btnCreateRoom    = document.getElementById("btn-create-room");
    const btnJoinRoom      = document.getElementById("btn-join-room");
    const btnResetAll      = document.getElementById("btn-reset-all");
    const messageDiv       = document.getElementById("message");
    const usersListUl      = document.getElementById("users-list");
    const countdownDiv     = document.getElementById("countdown");
    const quizQuestionText = document.getElementById("quiz-question");
    const turnIndicatorDiv = document.getElementById("turn-indicator");
    const quizOptionsDiv   = document.getElementById("quiz-options");
    const quizScoresDiv    = document.getElementById("quiz-scores");
    const winnerDiv        = document.getElementById("winner");
    const rankingListUl    = document.getElementById("ranking-list");

    // Banco de preguntas (100 preguntas de videojuegos)
    const questions = [
      { text: "¿Quién es el jefe final de Elden Ring?", options: ["Radagon", "Godfrey, el Primer Elden Lord", "Malenia, la Espada de Miquella", "Queen Marika"], correctIndex: 1 },
      { text: "¿En qué año se lanzó Call of Duty: Modern Warfare (2019)?", options: ["2018", "2019", "2020", "2021"], correctIndex: 1 },
      { text: "¿Cuál es el nombre de la IA principal en Call of Duty: Zombies (Black Ops)?", options: ["Samantha", "Edward Richtofen", "Luna", "Nikolai"], correctIndex: 0 },
      { text: "¿Cómo se llama el modo principal de Rocket League?", options: ["Rocket Domination", "Soccar", "Starball", "Rocket Cup"], correctIndex: 1 },
      { text: "¿Cuál es el nombre de la isla inicial en Fortnite Chapter 2?", options: ["Isla Sosiego", "Isla Neo Tilted", "Isla Pangolina", "Isla Coral"], correctIndex: 0 },
      { text: "¿En GTA V, cómo se llama el protagonista que sufre de narcolepsia?", options: ["Michael De Santa", "Franklin Clinton", "Trevor Philips", "Niko Bellic"], correctIndex: 2 },
      { text: "¿Cuál es el agente con habilidades de invisibilidad en Valorant?", options: ["Omen", "Cypher", "Sage", "Jett"], correctIndex: 0 },
      { text: "¿En Raft, cuál es el material principal para expandir tu balsa?", options: ["Madera", "Metal", "Plástico", "Algas"], correctIndex: 0 },
      { text: "¿Cuál es el dios principal de Smite que se añadió en la Temporada 5?", options: ["Ah Puch", "Baba Yaga", "Ravana", "Serqet"], correctIndex: 1 },
      { text: "¿Qué evento lanzó Overwatch 2 en su modo PvP principal?", options: ["Push", "Escort", "Control", "Hybrid"], correctIndex: 0 },
      { text: "¿Cómo se llama la expansión de FIFA 21 que introdujo Ultimate Team Seasons?", options: ["FUT Seasons", "FUT Rivals", "FUT Champions", "FUT Draft"], correctIndex: 0 },
      { text: "¿Cuál es el impostor más rápido en Among Us?", options: ["Infectar", "Ventear", "Sabotear", "Visión reducida"], correctIndex: 1 },
      { text: "¿Qué arma icónica usa Doomguy en Doom Eternal?", options: ["BFG 9000", "Escopeta de combate", "Misil HE", "Cañón de plasma"], correctIndex: 0 },
      { text: "¿En qué año se lanzó League of Legends?", options: ["2008", "2009", "2010", "2011"], correctIndex: 1 },
      { text: "¿Cuál fue el primer héroe añadido a Apex Legends después del lanzamiento?", options: ["Octane", "Wraith", "Bangalore", "Bloodhound"], correctIndex: 0 },
      { text: "¿Cómo se llama el mapa clásico de PUBG Mobile que lleva un nombre ruso?", options: ["Miramar", "Erangel", "Sanhok", "Vikendi"], correctIndex: 3 },
      { text: "¿Qué ciudad inspiró la ciudad de Ciudad de Piedra en Minecraft?", options: ["Berlín", "París", "Rennes-le-Château", "Barcelona"], correctIndex: 2 },
      { text: "¿Cuál es la habilidad definitiva de Ashe en Overwatch?", options: ["Coach Gun", "Dinamita", "B.O.B.", "Ballistic Vest"], correctIndex: 2 },
      { text: "¿Qué equipo ganó el primer Campeonato Mundial de League of Legends (2011)?", options: ["Fnatic", "Team SoloMid", "Invictus Gaming", "G2 Esports"], correctIndex: 0 },
      { text: "¿Cómo se llama el protagonista de Cyberpunk 2077? (Nombre predeterminado)", options: ["V", "Adam", "Johnny", "Jackie"], correctIndex: 0 },
      { text: "¿Cuál es el modo de juego que introdujo Warzone en Call of Duty?", options: ["Battle Royale", "Multijugador Clásico", "Zombies", "Gunfight"], correctIndex: 0 },
      { text: "¿En Rocket League, cuál es el nombre de la arena inspirada en el baloncesto?", options: ["Hoops", "Dunk House", "B-Ball Stadium", "Netty Heights"], correctIndex: 0 },
      { text: "¿Qué personaje de Fortnite tiene alas de ángel como accesorio?", options: ["Raptor", "Raven", "Wingman", "Reaper"], correctIndex: 2 },
      { text: "¿Cuál es la razón por la que Trevor abandona Los Santos en GTA V?", options: ["Huida de la ley", "Muerte de su hermano", "Robo fallido", "Problemas con el cartel"], correctIndex: 0 },
      { text: "¿Cuál es la habilidad pasiva de Phoenix en Valorant?", options: ["Renacimiento", "Curación al disparar", "Humo curativo", "Flash aumentado"], correctIndex: 3 },
      { text: "¿Qué criatura marina es el principal enemigo en Raft?", options: ["Tiburón martillo", "Tiburón blanco", "Megalodón", "Orca"], correctIndex: 1 },
      { text: "¿Quién es el dios gemelo de Freya en Smite 2?", options: ["Frey", "Odin", "Thor", "Loki"], correctIndex: 0 },
      { text: "¿Cómo se llama el mapa de captura de carga en Overwatch 2?", options: ["Stormkeep", "New Junk City", "Circuit Royal", "Yoshida Harbor"], correctIndex: 1 },
      { text: "¿En FIFA 22, qué jugador aparece en la portada de la edición estándar?", options: ["Lionel Messi", "Cristiano Ronaldo", "Kylian Mbappé", "Neymar Jr."], correctIndex: 2 },
      { text: "¿Cuál es la ubicación por defecto en Among Us cuando empieza una partida?", options: ["The Skeld", "Mira HQ", "Polus", "Airship"], correctIndex: 0 },
      { text: "¿Cuál es la clase de arma principal de Travis Touchdown en No More Heroes 3?", options: ["Beam Katana", "Pistol", "Shotgun", "Sniper Rifle"], correctIndex: 0 },
      { text: "¿Qué raza jugable introdujo Shadowlands en World of Warcraft?", options: ["Kyrian", "Venthyr", "Necrolord", "Nightborne"], correctIndex: 0 },
      { text: "¿Cuál es la isla inicial en Animal Crossing: New Horizons?", options: ["Isla Nook", "Isla Tortuga", "Isla Palmera", "Isla Doce"], correctIndex: 0 },
      { text: "¿Cómo se llama la expansión de The Witcher 3 lanzada en 2015?", options: ["Blood and Wine", "Hearts of Stone", "Wild Hunt", "Gwent"], correctIndex: 1 },
      { text: "¿Quién es el artista que canta la canción principal de Cyberpunk 2077, 'Chippin’ In'?", options: ["Snoh Aalegra", "Run the Jewels", "Grimes", "Keanu Reeves"], correctIndex: 1 },
      { text: "¿Cuál es la velocidad base de movimiento de Ashe en Overwatch 1?", options: ["5.5 m/s", "5.0 m/s", "5.5 yarde/s", "6.0 m/s"], correctIndex: 0 },
      { text: "¿Qué personaje de Fortnite tiene un pico llamado 'Renegade Roller'?", options: ["Renegade Raider", "Peely", "Drift", "Fable"], correctIndex: 0 },
      { text: "¿Cuál es el principal villano en Red Dead Redemption 2?", options: ["Dutch van der Linde", "Micah Bell", "Arthur Morgan", "Hosea Matthews"], correctIndex: 1 },
      { text: "¿Cuál es el valor máximo de habilidad en Valorant?", options: ["6", "7", "8", "9"], correctIndex: 1 },
      { text: "¿Cuál es el material para construir velas en Raft?", options: ["Soga", "Tela", "Maderas finas", "Aluminio"], correctIndex: 1 },
      { text: "¿Qué tipo de dios es Zeus en Smite 1?", options: ["Mago", "Asesino", "Guerrero", "Luchador"], correctIndex: 0 },
      { text: "¿Cuál es la habilidad final de Genji en Overwatch?", options: ["Dragonblade", "Swift Strike", "Deflect", "Shuriken"], correctIndex: 0 },
      { text: "¿Qué equipo ganó la Worlds 2018 en League of Legends?", options: ["Invictus Gaming", "Fnatic", "SK Telecom T1", "G2 Esports"], correctIndex: 0 },
      { text: "¿Cómo se llama el protagonista de Assassin’s Creed Valhalla?", options: ["Eivor", "Ezio Auditore", "Kassandra", "Bayek"], correctIndex: 0 },
      { text: "¿Qué popular juego de cartas se lanzó junto con Hearthstone en 2014?", options: ["Legends of Runeterra", "Gwent", "Artifact", "Shadowverse"], correctIndex: 1 },
      { text: "¿En Apex Legends, qué arma dispara proyectiles de aire?", options: ["Wingman", "Kraber", "Havoc", "L-STAR"], correctIndex: 3 },
      { text: "¿Cuál es la función del botón 'Ping' en Apex Legends?", options: ["Marcar enemigos", "Rendir homenaje", "Enviar mensaje de voz", "Cambiar arma"], correctIndex: 0 },
      { text: "¿Cuál es la velocidad de vehículo base en GTA Online para el Deluxo volador?", options: ["190 mph", "120 mph", "130 mph", "150 mph"], correctIndex: 0 },
      { text: "¿Cómo se llama el mapa nocturno exclusivo en Call of Duty: Modern Warfare 2 Remastered?", options: ["Rust", "Terminal", "Favela", "Highrise"], correctIndex: 1 },
      { text: "¿Qué evento crossover lanzó Fortnite con Marvel en 2020?", options: ["Nexus War", "Infinity Saga", "Galactus Hunt", "Avengers Assemble"], correctIndex: 0 },
      { text: "¿En Valorant, cuál agente puede colocar trampas que revelan enemigos?", options: ["Sova", "Cypher", "Brimstone", "Killjoy"], correctIndex: 1 },
      { text: "¿Cuál es la mascota de Raft que trae regalos cuando la alimentas?", options: ["Gaviota", "Foca", "Delfín", "Tortuga marina"], correctIndex: 0 },
      { text: "¿Cómo se llama la versión mobile de Smite?", options: ["Smite Arena", "Smite Blitz", "Smite Strike", "Smite Heroes"], correctIndex: 1 },
      { text: "¿Cuál es la principal función del 'Builder' en Fortnite Creative?", options: ["Construir mapas personalizados", "Comprar objetos", "Luchar contra zombis", "Personalizar armas"], correctIndex: 0 },
      { text: "¿Qué país ficticio aparece en Overwatch 2 como nuevo mapa?", options: ["Dorado", "Rio de Janeiro", "Toronto", "Busan"], correctIndex: 2 },
      { text: "¿Quién interpretó la voz de Kratos en God of War (2018)?", options: ["Troy Baker", "Christopher Judge", "David Hayter", "Nolan North"], correctIndex: 1 },
      { text: "¿Cuál es el principal enemigo final en Horizon Zero Dawn?", options: ["Hades", "Aloy", "Hephaestus", "Hela"], correctIndex: 0 },
      { text: "¿En Among Us, cuántos jugadores es el máximo oficial?", options: ["8", "10", "12", "14"], correctIndex: 2 },
      { text: "¿Qué héroe de Overwatch tiene dos espadas de energía?", options: ["Reaper", "Genji", "Tracer", "Soldier: 76"], correctIndex: 1 },
      { text: "¿Cómo se llama la expansión de Minecraft que introdujo aldeanos y bibliotecas?", options: ["Village & Pillage", "Nether Update", "Aquatic Update", "Bountiful Update"], correctIndex: 0 },
      { text: "¿Cuál es el nombre del evento de fútbol de FIFA 20 donde se añadieron equipos legendarios?", options: ["FUT Icons", "FUT Heroes", "Team of the Year", "Team of the Week"], correctIndex: 0 },
      { text: "¿En Valorant, cómo se llama la habilidad de Sage que resucita a un compañero?", options: ["Healing Orb", "Slow Orb", "Barrier Orb", "Resurrection"], correctIndex: 3 },
      { text: "¿Cuál es la meta de Raft cuando encuentras una parte del barco gigante?", options: ["Construir un hotel flotante", "Armar un barco más grande", "Derrotar al tiburón", "Encontrar un portal"], correctIndex: 1 },
      { text: "¿Qué dios de Smite es conocido como 'El Cazador de Dragones'?", options: ["Apollo", "Cupid", "Artemis", "Hun Batz"], correctIndex: 2 },
      { text: "¿Cuál es el principal baile (emote) de Fortnite con tema zombie?", options: ["Zombie Boogie", "Thriller", "Pump It Up", "Moonwalk"], correctIndex: 1 },
      { text: "¿Qué personaje de GTA Online vende autos de lujo modificados?", options: ["Lamar", "Tony Prince", "Lester Crest", "Cayde-6"], correctIndex: 1 },
      { text: "¿Cuál es el movimiento final de Genji en Overwatch 2?", options: ["Swift Dragon", "Dragonblade Extremo", "Shuriken Ultimate", "Dragonstrike"], correctIndex: 1 },
      { text: "¿Cuál es el nombre del modo de juego competitivo en Rocket League?", options: ["Ranked", "Pro League", "Championship", "Elite Cup"], correctIndex: 0 },
      { text: "¿Qué arma exclusividad COD Zombies dispara rayos de energía?", options: ["Ray Gun", "Monkey Bomb", "Thundergun", "Wunderwaffe DG-2"], correctIndex: 2 },
      { text: "¿En Among Us, cuántas tareas (tasks) mínimas puede haber en Skeld?", options: ["1", "2", "3", "4"], correctIndex: 0 },
      { text: "¿Cuál es la velocidad máxima de la bicicleta SpidaBike en GTA Online?", options: ["120 mph", "130 mph", "140 mph", "150 mph"], correctIndex: 2 },
      { text: "¿Qué modificación añadió el modo GTA V RP (Roleplay)?", options: ["Nuevo mapa", "Interacción social avanzada", "Modo construcción", "Carreras de drones"], correctIndex: 1 },
      { text: "¿Cuál es el nombre del jefe final de Elden Ring que causó polémica por su dificultad?", options: ["Malenia", "Radahn", "Godrick", "Grafted Scion"], correctIndex: 0 },
      { text: "¿En Rocket League, qué coche es considerado uno de los más populares en competitivo?", options: ["Octane", "Fennec", "Dominus", "Breakout"], correctIndex: 0 },
      { text: "¿Qué modo de juego introdujo Call of Duty: Warzone para 200 jugadores?", options: ["Battle Royale", "Plunder", "Resurgence", "Armored Royale"], correctIndex: 0 },
      { text: "¿Cuál es el arma más cara en el Pase de Batalla de Fortnite temporada 5?", options: ["Scar Legendary", "Golden Scar", "Mythic Scar", "Scar Enchanted"], correctIndex: 2 },
      { text: "¿Qué dios gemelo debutó en Smite 2 como personaje jugable?", options: ["Anhur y Anubis", "Fenrir y Freki", "Thor y Tyr", "Zhong Kui y Zhong Kui (Retribución)"], correctIndex: 0 },
      { text: "¿Qué habilidad de Jett en Valorant le permite deslizarse por el suelo?", options: ["Cloudburst", "Tailwind", "Updraft", "Blade Storm"], correctIndex: 1 },
      { text: "¿Cuál es el nombre de la expansión de FIFA 22 dedicada a Normas Pro?", options: ["Volta Football", "Pro Clubs", "Ultimate Team", "Career Mode"], correctIndex: 1 },
      { text: "¿En Among Us, qué tarea se realiza en la parte inferior del mapa (The Skeld)?", options: ["Fuel Engines", "Download/Upload Data", "Fix Wiring", "Prime Shields"], correctIndex: 1 },
      { text: "¿Qué héroe de Overwatch tiene una granada de pulso electromagnético como habilidad?", options: ["Moira", "Ana", "Ashe", "Torbjörn"], correctIndex: 3 },
      { text: "¿Cuál es la velocidad de caída estándar en Rocket League tras saltar?", options: ["7 m/s", "8 m/s", "8.5 m/s", "9 m/s"], correctIndex: 2 },
      { text: "¿Qué mapa de Modern Warfare (2019) se inspira en una estación de tren europea?", options: ["Train Station", "Piccadilly", "Piccadilly Metro", "Railway Yard"], correctIndex: 1 },
      { text: "¿Cuál es el nombre del modo de supervivencia en DayZ que comparte similitudes con Raft?", options: ["Hardcore Mode", "Pilgrim Mode", "Survivor Mode", "Wasteland Mode"], correctIndex: 1 },
      { text: "¿Qué tipo de habilidad tiene Mercy en Overwatch 2?", options: ["Sobrecarga de salud", "Resurrect", "Guardian Angel", "Angel Guardian"], correctIndex: 1 },
      { text: "¿Cuál es la consola exclusiva de lanzamiento de Fortnite en 2017?", options: ["PlayStation 4", "Xbox One", "Nintendo Switch", "PC"], correctIndex: 2 },
      { text: "¿Qué escenario icónico reapareció en CoD Zombies Black Ops Cold War?", options: ["Shi No Numa", "Kino Der Toten", "Ascension", "Die Maschine"], correctIndex: 3 },
      { text: "¿Cuál es la habilidad final de Zenyatta en Overwatch?", options: ["Orb of Discord", "Transcendence", "Orb of Harmony", "Rising Lotus"], correctIndex: 1 },
      { text: "¿Qué modo de juego agregó Rocket League en la temporada 9?", options: ["Hoops", "Rumble", "Dropshot", "Snow Day"], correctIndex: 2 },
      { text: "¿En FIFA 21, qué elemento del modo Carrera se mejoró considerablemente?", options: ["Simulación de partidos", "Mejoras de portero", "Pantalla de jugadas", "Modo Volta"], correctIndex: 0 },
      { text: "¿Cuál es la ubicación principal en Among Us Airship?", options: ["Flyar", "Skeld", "Polus", "Mira HQ"], correctIndex: 0 },
      { text: "¿Qué juego de la década introdujo el modo multijugador cooperativo L4D2?", options: ["Left 4 Dead 2", "Dead Rising 3", "Dying Light", "Resident Evil 6"], correctIndex: 0 },
      { text: "¿Cuál es la habilidad definitiva de Tracer en Overwatch 2?", options: ["Pulse Bomb", "Blink", "Recall", "Time Warp"], correctIndex: 0 },
      { text: "¿Qué famoso streamer colaboró con Rocket League para una serie de eventos caritativos en 2020?", options: ["Ninja", "Shroud", "Tfue", "Dr Disrespect"], correctIndex: 2 },
      { text: "¿En GTA V Online, cuál es la velocidad máxima del Deluxo en modo vuelo?", options: ["190 mph", "180 mph", "200 mph", "195 mph"], correctIndex: 0 },
      { text: "¿Cuál es el nombre de la actualización grande que trajo la isla de Cornwall en Fortnite?", options: ["Capítulo 2", "Capítulo 3", "Capítulo 4", "Capítulo 5"], correctIndex: 1 },
      { text: "¿Qué arma de COD Zombies en Black Ops 4 dispara una barra eléctrica?", options: ["Death Machine", "Tesla Gun", "Staff of Lightning", "Ray Gun Mk II"], correctIndex: 1 },
      { text: "¿Cuál es el nombre del evento continuo de Overwatch 2 que introduce mapas PvE?", options: ["Season Zero", "Rift Watch", "Hero Stories", "Archives"], correctIndex: 2 },
      { text: "¿Qué equipo ganó la Copa Mundial de Rocket League 2021?", options: ["Team Vitality", "NRG Esports", "Cloud9", "Dignitas"], correctIndex: 1 },
      { text: "¿Cuál es la habilidad definitiva de Genji en Overwatch 1 (reaparece en Overwatch 2)?", options: ["Dragonblade", "Swift Strike", "Deflect", "Shuriken Storm"], correctIndex: 0 }
    ];

    // —— Ranking general de victorias (escucha /ranking) ——
    function listenToGeneralRanking() {
      const rankRef = ref(db, "ranking");
      onValue(rankRef, snapshot => {
        const ranking = snapshot.val() || {};
        // Ordenar por número de victorias descendente
        const sorted = Object.entries(ranking)
          .sort((a,b) => b[1] - a[1]);

        rankingListUl.innerHTML = "";
        sorted.forEach(([user, wins], idx) => {
          const li = document.createElement("li");
          li.classList.add("list-item");
          li.textContent = `${user}: ${wins} victorias`;
          // Agregar corona SVG al primer puesto
          if (idx === 0) {
            const crownSvg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            crownSvg.setAttribute("viewBox", "0 0 24 24");
            crownSvg.setAttribute("class", "crown-icon");
            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.setAttribute("d", "M5 16L3 6l5 4 4-5 4 5 5-4-2 10H5z");
            path.setAttribute("fill", "gold");
            crownSvg.appendChild(path);
            li.insertBefore(crownSvg, li.firstChild);
          }
          rankingListUl.appendChild(li);
        });
      });
    }

    // 3) Funciones auxiliares
    function showMessage(txt) {
      messageDiv.textContent = txt;
      setTimeout(() => { messageDiv.textContent = ""; }, 3000);
    }
    function clearUsersList() {
      usersListUl.innerHTML = "";
    }

    // 4) CREATE ROOM
    function createRoom() {
      const roomId   = roomIdInput.value.trim();
      const userName = userNameInput.value.trim();
      if (!roomId || !userName) {
        showMessage("Completa ambos campos");
        return;
      }
      currentRoomId   = roomId;
      currentUserName = userName;

      // Inicializar “state” con:
      // turnIndex=0, pointer=0, questionOrder=[], scores={userName:0}
      //   + usedQuestions: {}  (registro de índices que YA se usaron en juegos previos)
      set(ref(db, `salas/${roomId}`), {
        state: {
          turnIndex: 0,
          pointer: 0,
          questionOrder: [],
          scores: { [userName]: 0 }
        },
        usedQuestions: {} // objeto vacío para empezar
      })
      .then(() => {
        // Añadir usuario a “usuarios” en esa sala
        return set(ref(db, `salas/${roomId}/usuarios/${userName}`), true);
      })
      .then(() => {
        listenToGeneralRanking(); // para actualizar ranking global en interfaz
        listenToUsers(roomId);
        showMessage(`Sala creada: ${roomId}`);
      })
      .catch(err => {
        showMessage("Error al crear sala: " + err.message);
      });
    }

    // 5) JOIN ROOM
    function joinRoom() {
      const roomId   = roomIdInput.value.trim();
      const userName = userNameInput.value.trim();
      if (!roomId || !userName) {
        showMessage("Completa ambos campos");
        return;
      }
      currentRoomId   = roomId;
      currentUserName = userName;

      // Añadir usuario a “usuarios” en esa sala
      set(ref(db, `salas/${roomId}/usuarios/${userName}`), true)
      .then(() => {
        // Asegurar que en state/scores existe la clave con valor 0
        return set(ref(db, `salas/${roomId}/state/scores/${userName}`), 0);
      })
      .then(() => {
        listenToGeneralRanking();
        listenToUsers(roomId);
        showMessage(`Unido a la sala: ${roomId}`);
      })
      .catch(err => {
        showMessage("Error al unirse: " + err.message);
      });
    }

    // 6) RESET ALL
    function resetAll() {
      remove(ref(db, "salas"))
      .then(() => {
        showMessage("Todas las salas fueron reiniciadas");
        clearUsersList();
        rankingListUl.innerHTML = "";
        countdownDiv.textContent = "";
        hasCountdownStarted = false;
        if (countdownTimer) {
          clearInterval(countdownTimer);
          countdownTimer = null;
        }
      })
      .catch(err => {
        showMessage("Error al reiniciar: " + err.message);
      });
    }

    // 7) LISTENER a “salas/{roomId}/usuarios”
    function listenToUsers(roomId) {
      hasCountdownStarted = false;
      countdownValue = 15;
      countdownDiv.textContent = "";

      const usuariosRef = ref(db, `salas/${roomId}/usuarios`);
      onValue(usuariosRef, snapshot => {
        const usersObj = snapshot.val() || {};
        const userList = Object.keys(usersObj).sort();
        userListGlobal = userList;

        usersListUl.innerHTML = "";
        userList.forEach(user => {
          const li = document.createElement("li");
          li.textContent = user;
          usersListUl.appendChild(li);
        });

        // Si hay al menos 3 jugadores, arranca cuenta atrás (una sola vez)
        if (userList.length >= 3 && !hasCountdownStarted) {
          startCountdown();
        }
      });
    }

    // 8) LISTENERS a “state” de la sala: turnIndex, pointer, questionOrder y scores
    function listenToState(roomId) {
      // A) Listener para cambios en state (se obtiene todo el objeto state de una vez)
      const stateRef = ref(db, `salas/${roomId}/state`);
      onValue(stateRef, async snapshot => {
        const state = snapshot.val();
        if (!state) return;

        // Si questionOrder está vacío (quiz aún no generado), generamos orden nuevo:
        if (!Array.isArray(state.questionOrder) || state.questionOrder.length === 0) {
          await generateNewQuestionOrder(roomId);
          return; // después de generar, el listener volverá a dispararse con el nuevo state
        }

        // Si pointer >= questionOrder.length => fin de quiz
        if (state.pointer >= state.questionOrder.length) {
          endQuizUI(roomId);
          return;
        }

        // Mostrar turno y pregunta actual
        const turnIndex = state.turnIndex || 0;
        const userList = userListGlobal;
        if (!Array.isArray(userList) || userList.length === 0) return;
        const currentPlayer = userList[turnIndex % userList.length];
        turnIndicatorDiv.textContent = `Turno de: ${currentPlayer}`;

        showQuestionUI(state.questionOrder[state.pointer], currentPlayer);
      });

      // B) Listener para scores: actualiza ranking de la partida en UI
      const scoresRef = ref(db, `salas/${roomId}/state/scores`);
      onValue(scoresRef, snapshot => {
        const scores = snapshot.val() || {};
        updateRankingUI(scores);
      });
    }

    // 9) CUENTA ATRÁS (15 s) y luego transición a Quiz
    function startCountdown() {
      hasCountdownStarted = true;
      countdownDiv.textContent = `Comienza en ${countdownValue} s`;
      countdownTimer = setInterval(() => {
        countdownValue--;
        if (countdownValue > 0) {
          countdownDiv.textContent = `Comienza en ${countdownValue} s`;
        } else {
          clearInterval(countdownTimer);
          countdownDiv.textContent = "¡Arranca el juego!";
          setTimeout(() => {
            transitionToQuiz();
          }, 500);
        }
      }, 1000);
    }

    // 10) TRANSICIÓN a Quiz
    function transitionToQuiz() {
      joinScreenDiv.classList.add("hidden");
      quizScreenDiv.classList.remove("hidden");
      listenToState(currentRoomId);
    }

    // 11) Mostrar pregunta y opciones basadas en índice de pregunta (questionIndex)
    //    Aquí, en lugar de usar questionIndex secuencial, usamos directamente el índice
    //    que viene de questionOrder[state.pointer].
    function showQuestionUI(questionIndex, currentPlayer) {
      if (questionIndex == null) return;
      const qObj = questions[questionIndex];
      if (!qObj) return;

      quizQuestionText.textContent = qObj.text;
      quizOptionsDiv.innerHTML = "";

      qObj.options.forEach((opt, idx) => {
        const btn = document.createElement("button");
        btn.textContent = opt;
        btn.disabled = (currentPlayer !== currentUserName);
        btn.addEventListener("click", () => handleAnswer(idx));
        quizOptionsDiv.appendChild(btn);
      });
    }

    // 12) Actualizar ranking de la partida en UI
    function updateRankingUI(scores) {
      quizScoresDiv.innerHTML = "";
      // Ordenar por puntaje descendente
      const sorted = Object.entries(scores)
        .sort((a,b) => b[1] - a[1]);
      sorted.forEach(([user, score], idx) => {
        const div = document.createElement("div");
        div.textContent = `${user}: ${score} pts`;
        quizScoresDiv.appendChild(div);
      });
    }

    // 13) Manejar respuesta (runTransaction con userListGlobal)
    //     En lugar de incrementar questionIndex, incrementamos pointer.
    function handleAnswer(selectedIndex) {
      const stateRef = ref(db, `salas/${currentRoomId}/state`);
      runTransaction(stateRef, state => {
        if (!state) return state;
        const ptr = state.pointer || 0;
        const order = state.questionOrder || [];
        const turnIndex = state.turnIndex || 0;
        const scores = state.scores || {};
        const userList = userListGlobal;
        if (!Array.isArray(userList) || userList.length === 0) return state;

        const currentPlayer = userList[turnIndex % userList.length];
        if (currentPlayer !== currentUserName) return state;

        const questionIdx = order[ptr];
        const qObj = questions[questionIdx];
        if (!qObj) return state;

        // Si acierta, suma punto. En ambos casos, avanzamos pointer y turno.
        if (selectedIndex === qObj.correctIndex) {
          state.scores[currentUserName] = (state.scores[currentUserName] || 0) + 1;
        }
        state.pointer = ptr + 1;
        state.turnIndex = (turnIndex + 1) % userList.length;
        return state;
      }, {
        onComplete: (err, committed, snapshot) => {
          if (err) console.error("runTransaction error:", err);
          if (!committed) console.warn("Transaction no fue comprometida");
        }
      });
    }

    // 14) Finalizar quiz en UI
    //     Cuando pointer >= questionOrder.length, este método se llama.
    //     Además, aquí registramos en Firebase todas las preguntas usadas en esta partida,
    //     para que no se repitan en la siguiente.
    async function endQuizUI(roomId) {
      // Obtenemos el state actual una vez para saber qué order se usó
      const stateSnap = await get(ref(db, `salas/${roomId}/state`));
      const state = stateSnap.val();
      const usedOrder = Array.isArray(state?.questionOrder) ? state.questionOrder : [];

      // 1) Mostrar ganador (igual que antes)
      const finalScores = state?.scores || {};
      const sortedScores = Object.entries(finalScores).sort((a,b) => b[1] - a[1]);
      if (sortedScores.length) {
        const [winnerName] = sortedScores[0];
        winnerDiv.innerHTML = `<h3>🎉 ¡El ganador es ${winnerName}! 🎉</h3>`;
      } else {
        winnerDiv.textContent = "No hay participantes.";
      }

      // 2) Marcar en Firebase estas preguntas como “usadas”
      const updates = {};
      usedOrder.forEach(idx => {
        updates[`salas/${roomId}/usedQuestions/${idx}`] = true;
      });
      await update(ref(db), updates);

      // 3) Después de 5 segundos, reiniciamos a pantalla de Join y limpiamos UI
      setTimeout(() => {
        resetToJoin(roomId);
      }, 5000);
    }

    // 15) Resetear a Join Room
    //     Reinicia la UI, limpia listas y detiene timers.
    //     Importante: NO se resetea “usedQuestions”—eso persiste entre quizzes.
    async function resetToJoin(roomId) {
      quizQuestionText.textContent = "";
      turnIndicatorDiv.textContent = "";
      quizOptionsDiv.innerHTML = "";
      quizScoresDiv.innerHTML = "";
      winnerDiv.textContent = "";

      joinScreenDiv.classList.remove("hidden");
      quizScreenDiv.classList.add("hidden");
      clearUsersList();
      rankingListUl.innerHTML = "";
      countdownDiv.textContent = "";
      hasCountdownStarted = false;
      userListGlobal = [];
      if (countdownTimer) {
        clearInterval(countdownTimer);
        countdownTimer = null;
      }

      // Además, limpiamos el estado del juego (turnIndex, pointer, questionOrder, scores),
      // pero SIN tocar usedQuestions (para conservarlas).
      // Luego cada vez que alguien genere/creé de nuevo la sala o se reinicie manualmente,
      // se invocará createRoom o resetAll y allí se volverá a inicializar usedQuestions.
      await set(ref(db, `salas/${roomId}/state`), {
        turnIndex: 0,
        pointer: 0,
        questionOrder: [],
        scores: {}
      });
    }

    // 16) Generar nuevo orden aleatorio de preguntas para la sala,
    //     excluyendo aquellas que ya estén en usedQuestions.
    async function generateNewQuestionOrder(roomId) {
      // 1) Leer usedQuestions del DB
      const usedSnap = await get(ref(db, `salas/${roomId}/usedQuestions`));
      const usedObj = usedSnap.val() || {};
      const usedIndices = new Set(Object.keys(usedObj).map(k => parseInt(k)));

      // 2) Construir array de índices disponibles
      const allIndices = questions.map((_, i) => i);
      const remaining = allIndices.filter(i => !usedIndices.has(i));

      // 3) Si ya no queda ninguna (remaining.length === 0), reiniciamos usedQuestions en DB
      if (remaining.length === 0) {
        await set(ref(db, `salas/${roomId}/usedQuestions`), {});
        remaining.push(...allIndices);
      }

      // 4) Mezclar “remaining” de forma aleatoria (Fisher-Yates)
      for (let i = remaining.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [remaining[i], remaining[j]] = [remaining[j], remaining[i]];
      }

      // 5) Escribir en state.questionOrder el array “remaining” y dejar pointer = 0, turnIndex = 0
      await update(ref(db, `salas/${roomId}/state`), {
        questionOrder: remaining,
        pointer: 0,
        turnIndex: 0,
        scores: {} // reseteamos puntuaciones para todos; cada jugador ya debería estar en scores=0 por Join/crear
      });
    }

    // 17) Eventos de botón
    btnCreateRoom.addEventListener("click", createRoom);
    btnJoinRoom.addEventListener("click", joinRoom);
    btnResetAll.addEventListener("click", () => {
      resetAll();
      listenToGeneralRanking();
    });

    // Al cargar la página, arrancamos el listener del ranking general
    listenToGeneralRanking();
  </script>
</body>
</html>
