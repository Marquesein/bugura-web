<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WebRTC Chat App</title>
</head>
<body>
  <h2>WebRTC Chat App</h2>

  <div>
    <input type="text" id="roomInput" placeholder="Enter room name" />
    <button id="btnCreateRoom">Create Room</button>
    <button id="btnJoinRoom">Join Room</button>
    <button id="btnResetAll">Reset</button>
  </div>

  <div>
    <textarea id="messages" rows="10" cols="50" readonly></textarea>
  </div>

  <div>
    <input type="text" id="messageInput" placeholder="Type message..." />
    <button id="btnSend">Send</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-app.js";
    import {
      getDatabase,
      ref,
      set,
      get,
      onValue,
      remove,
    } from "https://www.gstatic.com/firebasejs/9.0.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCAnxoKIWFn0vK1ETc0pclEF9FGSlvBfs",
      authDomain: "webrtc-test-chat.firebaseapp.com",
      databaseURL: "https://webrtc-test-chat-default-rtdb.firebaseio.com",
      projectId: "webrtc-test-chat",
      storageBucket: "webrtc-test-chat.appspot.com",
      messagingSenderId: "539391976733",
      appId: "1:539391976733:web:6c977d55ecedb504206cad",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const roomInput = document.getElementById("roomInput");
    const btnCreateRoom = document.getElementById("btnCreateRoom");
    const btnJoinRoom = document.getElementById("btnJoinRoom");
    const btnResetAll = document.getElementById("btnResetAll");
    const btnSend = document.getElementById("btnSend");
    const messageInput = document.getElementById("messageInput");
    const messagesTextArea = document.getElementById("messages");

    let roomName = "";
    let peerConnection;
    let dataChannel;
    const configuration = {
      iceServers: [
        {
          urls: "stun:stun.l.google.com:19302",
        },
      ],
    };

    function createRoom() {
      roomName = roomInput.value;
      if (!roomName) return alert("Room name required");

      peerConnection = new RTCPeerConnection(configuration);
      dataChannel = peerConnection.createDataChannel("chat");
      dataChannel.onmessage = handleMessage;

      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          set(ref(db, roomName + "/callerICE"), JSON.stringify(event.candidate));
        }
      };

      peerConnection.createOffer()
        .then((offer) => peerConnection.setLocalDescription(offer))
        .then(() => {
          set(ref(db, roomName + "/offer"), JSON.stringify(peerConnection.localDescription));
        });

      onValue(ref(db, roomName + "/answer"), (snapshot) => {
        const answer = snapshot.val();
        if (answer) {
          peerConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(answer)));
        }
      });

      onValue(ref(db, roomName + "/calleeICE"), (snapshot) => {
        const ice = snapshot.val();
        if (ice) {
          peerConnection.addIceCandidate(new RTCIceCandidate(JSON.parse(ice)));
        }
      });
    }

    function joinRoom() {
      roomName = roomInput.value;
      if (!roomName) return alert("Room name required");

      peerConnection = new RTCPeerConnection(configuration);
      peerConnection.ondatachannel = (event) => {
        dataChannel = event.channel;
        dataChannel.onmessage = handleMessage;
      };

      peerConnection.onicecandidate = (event) => {
        if (event.candidate) {
          set(ref(db, roomName + "/calleeICE"), JSON.stringify(event.candidate));
        }
      };

      get(ref(db, roomName + "/offer")).then((snapshot) => {
        const offer = snapshot.val();
        if (!offer) return alert("Offer not found");

        peerConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(offer)))
          .then(() => peerConnection.createAnswer())
          .then((answer) => peerConnection.setLocalDescription(answer))
          .then(() => {
            set(ref(db, roomName + "/answer"), JSON.stringify(peerConnection.localDescription));
          });
      });

      onValue(ref(db, roomName + "/callerICE"), (snapshot) => {
        const ice = snapshot.val();
        if (ice) {
          peerConnection.addIceCandidate(new RTCIceCandidate(JSON.parse(ice)));
        }
      });
    }

    function handleMessage(event) {
      messagesTextArea.value += "Peer: " + event.data + "\n";
    }

    function sendMessage() {
      const message = messageInput.value;
      if (!message || !dataChannel) return;
      dataChannel.send(message);
      messagesTextArea.value += "Me: " + message + "\n";
      messageInput.value = "";
    }

    function resetAll() {
      if (roomName) {
        remove(ref(db, roomName));
      }
      location.reload();
    }

    // CONECTAR LOS BOTONES A LAS FUNCIONES
    btnCreateRoom.addEventListener("click", createRoom);
    btnJoinRoom.addEventListener("click", joinRoom);
    btnResetAll.addEventListener("click", resetAll);
    btnSend.addEventListener("click", sendMessage);
  </script>
</body>
</html>
